<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title></title>
	<style>
		*{
			margin: 0;
			padding: 0;
		}
        body{
            width: 100vw;
            overflow-x: hidden;
        }
		.propose-container {
			width: 100%;
			height: 100vh;
			background: transparent;
			position: relative;
			overflow: hidden;
		}
		.propose-popup {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%) scale(0.5);
			background: rgba(255, 255, 255, 0.1);
			backdrop-filter: blur(10px);
			padding: 2rem 4rem;
			border-radius: 20px;
			border: 1px solid rgba(255, 255, 255, 0.2);
			color: #fff;
			font-family: 'Heading', sans-serif;
			text-align: center;
			opacity: 0;
			pointer-events: none;
			z-index: 10;
		}
		.propose-popup h1 {
			font-size: 3rem;
			margin: 0;
			text-transform: uppercase;
			letter-spacing: 5px;
		}
		.propose-popup button {
			margin-top: 2rem;
			padding: 1rem 3rem;
			font-family: inherit;
			font-size: 1.5rem;
			font-weight: 900;
			background: #fff;
			color: #111;
			border: none;
			border-radius: 50px;
			cursor: pointer;
			text-transform: uppercase;
			transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
		}
		.propose-popup button:hover {
			transform: scale(1.1);
		}
		.propose-popup button:active {
			transform: scale(0.95);
		}
	</style>
</head>
<body>

<div style="height: 100vh; background: #111; display:flex; align-items:center; justify-content:center; color:white;"><h1>Scroll Down</h1></div>

<div class="propose-container" id="proposeContainer">
	<div class="propose-popup" id="proposePopup">
		<h1>Will you?</h1>
		<button id="acceptBtn">YES</button>
	</div>
</div>

<div class="flower-container" style="height: 100vh; background: #111;"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollToPlugin.min.js"></script>
<script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
<script type="importmap">
  {
	"imports": {
	  "three": "https://unpkg.com/three@0.156.1/build/three.module.js",
	  "three/addons/": "https://unpkg.com/three@0.156.1/examples/jsm/"
	}
  }
</script>

<script type="module">
	import * as THREE from 'three';
	import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
	import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
	import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

	gsap.registerPlugin(ScrollTrigger, ScrollToPlugin);

	/**
	 * Isolates the Propose section logic to prevent conflicts with other Three.js/Canvas instances
	 * @param {string} containerId - The ID of the container element
	 * @param {string} destinationSelector - The selector to scroll to after clicking YES
	 */
	function initProposeSection(containerId, destinationSelector) {
		const container = document.getElementById(containerId);
		if (!container) return;

		const width = container.clientWidth;
		const height = container.clientHeight;

		// --- Local Scoped Three.js Objects ---
		const scene = new THREE.Scene();
		const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
		camera.position.set(0, 0, 5);

		const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
		renderer.setSize(width, height);
		renderer.setPixelRatio(window.devicePixelRatio);
		renderer.toneMapping = THREE.ACESFilmicToneMapping;
		renderer.toneMappingExposure = 1.2;
		renderer.outputColorSpace = THREE.SRGBColorSpace;
		container.appendChild(renderer.domElement);

		const controls = new OrbitControls(camera, renderer.domElement);
		controls.enableDamping = true;
		controls.dampingFactor = 0.05;
		controls.enableZoom = false;
		controls.enablePan = false;

		// Environment Loading
		const pmremGenerator = new THREE.PMREMGenerator(renderer);
		pmremGenerator.compileEquirectangularShader();

		new RGBELoader().load('neutral.hdr', (texture) => {
			const envMap = pmremGenerator.fromEquirectangular(texture).texture;
			scene.environment = envMap;
			texture.dispose();
			pmremGenerator.dispose();
		});

		// Model Loading & Animation setup
		let model;
		let centeredPosition;
		
		new GLTFLoader().load('red_rose.glb', (gltf) => {
			model = gltf.scene;
			
			model.traverse((child) => {
				if (child.isMesh && child.material) {
					child.material.envMapIntensity = 1.5;
					if (child.material.map) child.material.map.colorSpace = THREE.SRGBColorSpace;
					child.material.needsUpdate = true;
				}
			});

			// Scaling & Centering
			const box = new THREE.Box3().setFromObject(model);
			const size = box.getSize(new THREE.Vector3());
			const center = box.getCenter(new THREE.Vector3());
			const scale = 4 / Math.max(size.x, size.y, size.z);
			model.scale.setScalar(scale);
			centeredPosition = new THREE.Vector3().copy(center).multiplyScalar(scale).negate();
			model.position.copy(centeredPosition);
			scene.add(model);

			// Animation Constants
			const targetPos = { x: 2.57, y: 2.73, z: -0.45 };
			const targetRot = { x: -1.73, y: 0.75, z: 1.81 };

			// GSAP Timeline (Scoped to this section)
			const tl = gsap.timeline({
				scrollTrigger: {
					trigger: `#${containerId}`,
					start: "top top",
					pin: true,
					pinSpacing: true,
					toggleActions: "restart none none none",
					onEnter: () => {
						document.body.style.overflow = 'hidden';
						camera.position.set(0, 0, 5);
						camera.rotation.set(0, 0, 0);
						model.position.copy(centeredPosition);
						model.rotation.set(0, 0, 0);
						controls.update();
						// Scoped popup selection
						const localPopup = container.querySelector('.propose-popup');
						if (localPopup) {
							gsap.set(localPopup, { opacity: 0, scale: 0.5, pointerEvents: "none" });
						}
					}
				}
			});

			tl.from(model.position, { y: centeredPosition.y - 5, z: 10, duration: 2, ease: "power4.out" })
			  .to(camera.position, { ...targetPos, duration: 2.5, ease: "power2.inOut" }, "-=1")
			  .to(camera.rotation, { ...targetRot, duration: 2.5, ease: "power2.inOut" }, "<");

			// Scoped popup reveal
			const localPopup = container.querySelector('.propose-popup');
			if (localPopup) {
				tl.to(localPopup, { opacity: 1, scale: 1, duration: 1, ease: "back.out(1.7)", pointerEvents: "auto" }, "-=0.5");
			}

			// Scoped Button Interaction
			const localBtn = container.querySelector('button');
			if (localBtn && localPopup) {
				localBtn.addEventListener('click', () => {
					gsap.to(localPopup, {
						opacity: 0, scale: 0.5, duration: 0.5, ease: "power2.in",
						onComplete: () => {
							const exitTl = gsap.timeline({
								onComplete: () => {
									document.body.style.overflow = '';
									gsap.to(window, { scrollTo: { y: destinationSelector, autoKill: false }, duration: 1.5, ease: "power2.inOut" });
								}
							});
							exitTl.to(model.position, { y: centeredPosition.y - 5, z: 10, duration: 2, ease: "power4.in" })
							      .to(model.rotation, { y: "+=" + (Math.PI * 2), duration: 2, ease: "power2.inOut" }, "<");
						}
					});
				});
			}
		});

		// Scoped Resize Handler
		const handleResize = () => {
			const w = container.clientWidth;
			const h = container.clientHeight;
			camera.aspect = w / h;
			camera.updateProjectionMatrix();
			renderer.setSize(w, h);
		};
		window.addEventListener('resize', handleResize);

		// Scoped Animation Loop
		const animate = () => {
			requestAnimationFrame(animate);
			controls.update();
			renderer.render(scene, camera);
		};
		animate();
	}

	// Initialize with the specific ID and destination
	initProposeSection('proposeContainer', '.flower-container');
</script>
</script>
</body>
</html>